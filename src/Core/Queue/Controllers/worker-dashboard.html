<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Workers Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 0.95rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .stat-card .value {
            color: #333;
            font-size: 2rem;
            font-weight: bold;
        }

        .workers-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: opacity 0.3s;
        }

        .refresh-btn:hover {
            opacity: 0.9;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .worker-grid {
            display: grid;
            gap: 20px;
        }

        .worker-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #ddd;
            transition: all 0.3s;
        }

        .worker-card.running {
            border-left-color: #4caf50;
            background: linear-gradient(90deg, rgba(76, 175, 80, 0.05) 0%, transparent 100%);
        }

        .worker-card.stopped {
            border-left-color: #f44336;
            background: linear-gradient(90deg, rgba(244, 67, 54, 0.05) 0%, transparent 100%);
        }

        .worker-card.processing {
            border-left-color: #2196f3;
            background: linear-gradient(90deg, rgba(33, 150, 243, 0.05) 0%, transparent 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .worker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .worker-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .worker-status {
            display: inline-flex;
            align-items: center;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .worker-status.running {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }

        .worker-status.running .status-indicator {
            background: #4caf50;
        }

        .worker-status.stopped {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .worker-status.stopped .status-indicator {
            background: #f44336;
            animation: none;
        }

        .worker-status.processing {
            background: rgba(33, 150, 243, 0.1);
            color: #2196f3;
        }

        .worker-status.processing .status-indicator {
            background: #2196f3;
        }

        .worker-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .info-value {
            color: #333;
            font-weight: 500;
        }

        .worker-stats {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .worker-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .control-btn.start {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .control-btn.stop {
            background: linear-gradient(135deg, #f44336, #da190b);
            color: white;
        }

        .control-btn.restart {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .control-btn.clear {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .job-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-card {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .error-title {
            color: #f44336;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .error-details {
            color: #666;
            font-size: 0.9rem;
            font-family: monospace;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #667eea;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .advanced-options {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
        }

        .advanced-options.hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üöÄ Queue Workers Dashboard</h1>
        <div class="subtitle">
            <span id="server-info">Server: Loading...</span> |
            <span id="last-update">Last update: Never</span>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="label">Total Workers</div>
            <div class="value" id="total-workers">0</div>
        </div>
        <div class="stat-card">
            <div class="label">Running</div>
            <div class="value" id="running-workers">0</div>
        </div>
        <div class="stat-card">
            <div class="label">Stopped</div>
            <div class="value" id="stopped-workers">0</div>
        </div>
        <div class="stat-card">
            <div class="label">Jobs Processed</div>
            <div class="value" id="total-processed">0</div>
        </div>
    </div>

    <div class="workers-section">
        <div class="section-title">
            <span>Workers Status</span>
            <button class="refresh-btn" onclick="refreshDashboard()">
                <span id="refresh-text">üîÑ Refresh</span>
            </button>
        </div>
        <div id="workers-grid" class="worker-grid">
            <!-- Workers will be loaded here -->
        </div>
    </div>

    <div class="job-form">
        <div class="section-title">
            <span>Send Test Job</span>
        </div>
        <form id="job-form">
            <div class="form-group">
                <label class="form-label">Job Name</label>
                <select class="form-select" id="job-name" required>
                    <option value="">Select a job...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Queue</label>
                <input type="text" class="form-input" id="queue" placeholder="e.g., employee_import" required>
            </div>

            <div class="form-group">
                <label class="form-label">Exchange</label>
                <input type="text" class="form-input" id="exchange" placeholder="e.g., employees">
            </div>

            <div class="form-group">
                <label class="form-label">Routing Key</label>
                <input type="text" class="form-input" id="routing-key" placeholder="e.g., employee.import">
            </div>

            <div class="form-group">
                <label class="form-label">
                    <div class="checkbox-group">
                        <span>Use Retry</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="use-retry">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </label>
            </div>

            <div id="retry-options" class="advanced-options hidden">
                <div class="form-group">
                    <label class="form-label">Retry Delay (ms)</label>
                    <input type="number" class="form-input" id="retry-delay" value="10000">
                </div>

                <div class="form-group">
                    <label class="form-label">Max Retries</label>
                    <input type="number" class="form-input" id="max-retries" value="5">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Job Data (JSON)</label>
                <textarea class="form-textarea" id="job-data" placeholder='{"key": "value"}'>{}</textarea>
            </div>

            <button type="submit" class="submit-btn">Send Job to Queue</button>

            <div id="form-message"></div>
        </form>
    </div>
</div>

<script>
    const API_BASE = '/api/queue';
    let autoRefreshInterval;
    let availableJobs = [];

    // –£—Ç–∏–ª–∏—Ç—ã
    const formatUptime = (seconds) => {
        if (!seconds) return 'N/A';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours}h ${minutes}m ${secs}s`;
    };

    const formatTimestamp = (timestamp) => {
        return new Date(timestamp).toLocaleString();
    };

    const showMessage = (elementId, message, isSuccess = false) => {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="${isSuccess ? 'success-message' : 'error-message'}">${message}</div>`;
        setTimeout(() => {
            element.innerHTML = '';
        }, 5000);
    };

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞
    async function refreshDashboard() {
        const refreshBtn = document.querySelector('.refresh-btn');
        refreshBtn.disabled = true;
        document.getElementById('refresh-text').innerHTML = '<span class="loading"></span> Loading...';

        try {
            const response = await fetch(`${API_BASE}/dashboard`);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to fetch dashboard data');
            }

            updateStats(data);
            updateWorkers(data.workers);
            updateServerInfo(data);

            document.getElementById('last-update').textContent = `Last update: ${formatTimestamp(new Date())}`;

        } catch (error) {
            console.error('Failed to refresh dashboard:', error);
            showMessage('form-message', `Failed to refresh: ${error.message}`);
        } finally {
            refreshBtn.disabled = false;
            document.getElementById('refresh-text').innerHTML = 'üîÑ Refresh';
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStats(data) {
        const workers = data.workers || [];
        const runningWorkers = workers.filter(w => w.alive).length;
        const stoppedWorkers = workers.length - runningWorkers;

        let totalProcessed = 0;
        workers.forEach(worker => {
            if (worker.stats && worker.stats.processed_jobs) {
                totalProcessed += worker.stats.processed_jobs;
            }
        });

        document.getElementById('total-workers').textContent = workers.length;
        document.getElementById('running-workers').textContent = runningWorkers;
        document.getElementById('stopped-workers').textContent = stoppedWorkers;
        document.getElementById('total-processed').textContent = totalProcessed;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ
    function updateServerInfo(data) {
        document.getElementById('server-info').textContent = `Server: ${data.server || 'Unknown'}`;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–≤
    function updateWorkers(workers) {
        const grid = document.getElementById('workers-grid');

        if (!workers || workers.length === 0) {
            grid.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">No workers configured</div>';
            return;
        }

        grid.innerHTML = workers.map(worker => createWorkerCard(worker)).join('');
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–æ—Ä–∫–µ—Ä–∞
    function createWorkerCard(worker) {
        const isRunning = worker.alive;
        const isProcessing = isRunning && worker.status && worker.status.data && worker.status.data.is_processing;

        const statusClass = isProcessing ? 'processing' : (isRunning ? 'running' : 'stopped');
        const statusText = isProcessing ? 'Processing' : (isRunning ? 'Running' : 'Stopped');

        const stats = worker.stats || {};
        const processedJobs = stats.processed_jobs || 0;
        const failedJobs = stats.failed_jobs || 0;
        const currentJob = stats.current_job || 'None';

        const errorSection = worker.last_error ? `
                <div class="error-card">
                    <div class="error-title">Last Error:</div>
                    <div class="error-details">${worker.last_error}</div>
                </div>
            ` : '';

        return `
                <div class="worker-card ${statusClass}">
                    <div class="worker-header">
                        <div class="worker-name">${worker.id}</div>
                        <div class="worker-status ${statusClass}">
                            <span class="status-indicator"></span>
                            ${statusText}
                        </div>
                    </div>

                    <div class="worker-info">
                        <div class="info-item">
                            <div class="info-label">Description</div>
                            <div class="info-value">${worker.config.description || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Queue</div>
                            <div class="info-value">${worker.config.queue}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Exchange</div>
                            <div class="info-value">${worker.config.exchange}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Uptime</div>
                            <div class="info-value">${formatUptime(worker.uptime)}</div>
                        </div>
                    </div>

                    <div class="worker-stats">
                        <div class="stat-item">
                            <div class="stat-number">${processedJobs}</div>
                            <div class="stat-label">Processed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${failedJobs}</div>
                            <div class="stat-label">Failed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${isProcessing ? '1' : '0'}</div>
                            <div class="stat-label">Active Jobs</div>
                        </div>
                    </div>

                    ${isProcessing ? `
                        <div class="info-item" style="margin-bottom: 15px;">
                            <div class="info-label">Current Job</div>
                            <div class="info-value">${currentJob}</div>
                        </div>
                    ` : ''}

                    ${errorSection}

                    <div class="worker-controls">
                        <button class="control-btn start" onclick="controlWorker('${worker.id}', 'start')" ${isRunning ? 'disabled' : ''}>
                            ‚ñ∂Ô∏è Start
                        </button>
                        <button class="control-btn stop" onclick="controlWorker('${worker.id}', 'stop')" ${!isRunning ? 'disabled' : ''}>
                            ‚èπÔ∏è Stop
                        </button>
                        <button class="control-btn restart" onclick="controlWorker('${worker.id}', 'restart')">
                            üîÑ Restart
                        </button>
                        <button class="control-btn clear" onclick="clearWorker('${worker.id}')">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>
            `;
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Ä–∫–µ—Ä–æ–º
    async function controlWorker(workerId, action) {
        try {
            const response = await fetch(`${API_BASE}/worker/${workerId}/${action}`, {
                method: 'POST'
            });
            const data = await response.json();

            if (response.ok) {
                showMessage('form-message', `Worker ${workerId} ${action}ed successfully!`, true);
                setTimeout(refreshDashboard, 1000);
            } else {
                showMessage('form-message', `Failed to ${action} worker: ${data.error}`);
            }
        } catch (error) {
            showMessage('form-message', `Error: ${error.message}`);
        }
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤–æ—Ä–∫–µ—Ä–∞
    async function clearWorker(workerId) {
        if (!confirm(`Are you sure you want to clear data for worker ${workerId}?`)) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/worker/${workerId}/clear`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (response.ok) {
                showMessage('form-message', `Worker ${workerId} data cleared successfully!`, true);
                setTimeout(refreshDashboard, 1000);
            } else {
                showMessage('form-message', `Failed to clear worker: ${data.error}`);
            }
        } catch (error) {
            showMessage('form-message', `Error: ${error.message}`);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á
    async function loadAvailableJobs() {
        try {
            const response = await fetch(`${API_BASE}/jobs`);
            const data = await response.json();

            if (response.ok) {
                availableJobs = data.jobs || [];
                const jobSelect = document.getElementById('job-name');

                jobSelect.innerHTML = '<option value="">Select a job...</option>';
                availableJobs.forEach(job => {
                    jobSelect.innerHTML += `<option value="${job.name}">${job.name} (${job.class})</option>`;
                });
            }
        } catch (error) {
            console.error('Failed to load jobs:', error);
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏
    document.getElementById('job-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            job_name: document.getElementById('job-name').value,
            queue: document.getElementById('queue').value,
            exchange: document.getElementById('exchange').value,
            routing_key: document.getElementById('routing-key').value,
            use_retry: document.getElementById('use-retry').checked,
            retry_delay_ms: parseInt(document.getElementById('retry-delay').value) || 10000,
            max_retries: parseInt(document.getElementById('max-retries').value) || 5,
        };

        // –ü–∞—Ä—Å–∏–Ω–≥ JSON –¥–∞–Ω–Ω—ã—Ö
        try {
            formData.job_data = JSON.parse(document.getElementById('job-data').value || '{}');
        } catch (error) {
            showMessage('form-message', 'Invalid JSON in job data');
            return;
        }

        const submitBtn = e.target.querySelector('.submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> Sending...';

        try {
            const response = await fetch(`${API_BASE}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('form-message', `Job sent successfully! Job: ${data.job_name}, Queue: ${data.queue}`, true);
                document.getElementById('job-form').reset();
                document.getElementById('job-data').value = '{}';
            } else {
                showMessage('form-message', `Failed to send job: ${data.error}`);
            }
        } catch (error) {
            showMessage('form-message', `Error: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Send Job to Queue';
        }
    });

    // Toggle retry options
    document.getElementById('use-retry').addEventListener('change', (e) => {
        const retryOptions = document.getElementById('retry-options');
        if (e.target.checked) {
            retryOptions.classList.remove('hidden');
        } else {
            retryOptions.classList.add('hidden');
        }
    });

    // Auto-fill queue and exchange based on job selection
    document.getElementById('job-name').addEventListener('change', (e) => {
        const selectedJob = availableJobs.find(job => job.name === e.target.value);
        if (selectedJob) {
            // Try to auto-fill based on common patterns
            const queueInput = document.getElementById('queue');
            const exchangeInput = document.getElementById('exchange');
            const routingKeyInput = document.getElementById('routing-key');

            // Auto-suggest based on job name patterns
            if (selectedJob.name.includes('employee')) {
                queueInput.value = 'employee_import';
                exchangeInput.value = 'employees';
                routingKeyInput.value = 'employee.import';
            } else if (selectedJob.name.includes('notification')) {
                queueInput.value = 'notifications';
                exchangeInput.value = 'notifications';
                routingKeyInput.value = 'notification.send';
            } else if (selectedJob.name.includes('report')) {
                queueInput.value = 'reports';
                exchangeInput.value = 'reports';
                routingKeyInput.value = 'report.generate';
            } else {
                // Default pattern
                const baseName = selectedJob.name.toLowerCase().replace(/job$/i, '');
                queueInput.value = `${baseName}_queue`;
                exchangeInput.value = baseName;
                routingKeyInput.value = `${baseName}.process`;
            }

            // Update job data with example based on job type
            const jobDataTextarea = document.getElementById('job-data');
            if (selectedJob.name.includes('employee')) {
                jobDataTextarea.value = JSON.stringify({
                    file_path: "/tmp/employees.json",
                    department: "IT",
                    notify_admin: true
                }, null, 2);
            } else if (selectedJob.name.includes('notification')) {
                jobDataTextarea.value = JSON.stringify({
                    recipient: "user@example.com",
                    subject: "Test Notification",
                    message: "This is a test message",
                    type: "email"
                }, null, 2);
            } else if (selectedJob.name.includes('report')) {
                jobDataTextarea.value = JSON.stringify({
                    report_type: "monthly",
                    date_from: "2024-01-01",
                    date_to: "2024-01-31",
                    format: "pdf"
                }, null, 2);
            } else {
                jobDataTextarea.value = JSON.stringify({
                    example_param: "value",
                    timestamp: new Date().toISOString()
                }, null, 2);
            }
        }
    });

    // Auto-refresh functionality
    function startAutoRefresh() {
        autoRefreshInterval = setInterval(refreshDashboard, 30000); // Refresh every 30 seconds
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    // Add auto-refresh toggle
    function addAutoRefreshToggle() {
        const header = document.querySelector('.header .subtitle');
        header.innerHTML += ` | Auto-refresh:
                <label class="toggle-switch" style="margin-left: 10px;">
                    <input type="checkbox" id="auto-refresh" checked>
                    <span class="toggle-slider"></span>
                </label>`;

        document.getElementById('auto-refresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + R –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        if ((e.ctrlKey || e.metaKey) && e.key === 'r' && !e.shiftKey) {
            e.preventDefault();
            refreshDashboard();
        }

        // Escape –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã
        if (e.key === 'Escape') {
            document.getElementById('job-form').reset();
            document.getElementById('job-data').value = '{}';
            document.getElementById('form-message').innerHTML = '';
        }
    });

    // WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    function initWebSocket() {
        // –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/queue`;

            const ws = new WebSocket(wsUrl);

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'worker_update') {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                        updateSingleWorker(data.worker);
                    }
                } catch (error) {
                    console.log('WebSocket message parsing failed:', error);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed');
                // –ú–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
                setTimeout(initWebSocket, 5000);
            };

            ws.onerror = () => {
                console.log('WebSocket connection failed');
            };

        } catch (error) {
            console.log('WebSocket not available:', error);
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞ (–¥–ª—è WebSocket)
    function updateSingleWorker(workerData) {
        const workerCard = document.querySelector(`[data-worker-id="${workerData.id}"]`);
        if (workerCard) {
            const newCard = createWorkerCard(workerData);
            workerCard.outerHTML = newCard;
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è API
    async function checkApiHealth() {
        try {
            const response = await fetch(`${API_BASE}/dashboard`);
            if (response.ok) {
                document.body.classList.remove('api-error');
            } else {
                document.body.classList.add('api-error');
            }
        } catch (error) {
            document.body.classList.add('api-error');
        }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è API
    const apiErrorStyles = `
            .api-error .header {
                border: 2px solid #f44336;
            }
            .api-error .header::after {
                content: " (API Connection Error)";
                color: #f44336;
                font-weight: bold;
            }
        `;

    const styleSheet = document.createElement('style');
    styleSheet.textContent = apiErrorStyles;
    document.head.appendChild(styleSheet);

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
    function exportDashboardData() {
        const data = {
            timestamp: new Date().toISOString(),
            server: document.getElementById('server-info').textContent,
            stats: {
                total_workers: document.getElementById('total-workers').textContent,
                running_workers: document.getElementById('running-workers').textContent,
                stopped_workers: document.getElementById('stopped-workers').textContent,
                total_processed: document.getElementById('total-processed').textContent
            },
            workers: Array.from(document.querySelectorAll('.worker-card')).map(card => {
                return {
                    name: card.querySelector('.worker-name').textContent,
                    status: card.querySelector('.worker-status').textContent.trim(),
                    queue: card.querySelector('.info-value').textContent
                };
            })
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `queue-dashboard-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞
    function addExportButton() {
        const refreshBtn = document.querySelector('.refresh-btn');
        const exportBtn = document.createElement('button');
        exportBtn.className = 'refresh-btn';
        exportBtn.innerHTML = 'üì• Export';
        exportBtn.onclick = exportDashboardData;
        refreshBtn.parentNode.insertBefore(exportBtn, refreshBtn.nextSibling);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function initApp() {
        console.log('üöÄ Initializing Queue Dashboard...');

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã UI
        addAutoRefreshToggle();
        addExportButton();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        await loadAvailableJobs();
        await refreshDashboard();

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        startAutoRefresh();

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ API
        setInterval(checkApiHealth, 60000); // –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å WebSocket
        // initWebSocket();

        console.log('‚úÖ Dashboard initialized successfully');
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    window.addEventListener('error', (event) => {
        console.error('Application error:', event.error);
        showMessage('form-message', `Application error: ${event.error.message}`);
    });

    window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        showMessage('form-message', `Promise error: ${event.reason}`);
    });

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', initApp);

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
        stopAutoRefresh();
    });

    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–¥–æ—Å—Ç—É–ø–Ω—ã –≤ console)
    window.QueueDashboard = {
        refreshDashboard,
        controlWorker,
        clearWorker,
        exportDashboardData,
        loadAvailableJobs,
        API_BASE
    };
</script>
</body>
</html>