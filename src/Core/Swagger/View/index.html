<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Документация к websps" />
    <title>Документация к websps</title>
    <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui.css" />
</head>
<body>

<div id="swagger-ui"></div>
<script src="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui-bundle.js" crossorigin></script>
<script src="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui-standalone-preset.js"></script>
<script>
    window.onload = function() {
        // Сначала обновляем токен через refresh endpoint
        fetch('/api/auth/refresh-tokens', {
            method: 'POST',
            credentials: 'include' // важно для передачи cookies и получения новых
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to refresh token');
                }

                // Получаем access token из заголовка Authorization
                const accessToken = response.headers.get('Authorization');

                if (accessToken) {
                    // Инициализируем Swagger UI с полученным токеном
                    const ui = SwaggerUIBundle({
                        url: '/swagger/openapi.yaml',
                        dom_id: '#swagger-ui',
                        presets: [
                            SwaggerUIBundle.presets.apis,
                            SwaggerUIStandalonePreset
                        ],
                        plugins: [
                            SwaggerUIBundle.plugins.DownloadUrl
                        ],
                        layout: "StandaloneLayout",
                        requestInterceptor: function(request) {
                            request.headers['Authorization'] = accessToken;
                            return request;
                        },
                        // Дополнительно: можно указать, что загрузка спецификации тоже требует авторизации
                        fetch: function(url, init) {
                            // Добавляем токен для загрузки самой спецификации
                            if (url.includes('/api/docs/openapi.yaml')) {
                                init.headers = init.headers || {};
                                init.headers['Authorization'] = accessToken;
                            }
                            return SwaggerUIBundle.fn.fetch(url, init);
                        }
                    });
                } else {
                    throw new Error('No access token in response headers');
                }
            })
            .catch(error => {
                console.error('Ошибка обновления токена:', error);
                alert('Не удалось получить доступ к API. Пожалуйста, авторизуйтесь в основном приложении.');
                // window.location.href = '/public';
            });
    };
</script>
</body>
</html>